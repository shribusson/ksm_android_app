# ТЗ: внутренняя платформа‑конструктор чат‑ботов для HR‑опросов (аналог boris.bot)

## 1) Вводные

### 1.1) Назначение
Веб‑платформа для создания и запуска чат‑ботов‑опросов для внутренних HR‑задач.

### 1.2) Обязательные ограничения
- **Одна роль**: один тип пользователя с доступом ко всему функционалу.
- Каналы: **Telegram** и **WhatsApp**.
- Сценарии: **только алгоритмические**. Любые LLM‑модули, генерация текста, RAG и похожие функции отсутствуют.
- Дашборды внутри системы не нужны.
- Результаты должны выгружаться через **Export в Excel (.xlsx)**. CSV не обязателен.
- Интеграции с Google Drive/Google Sheets и другими внешними системами не нужны.
- Интеграция с WhatsApp должна быть **самописной**, без провайдеров (Twilio/360dialog и т.п.).

### 1.3) Успешный результат
HR создаёт сценарий, подключает Telegram и WhatsApp, пользователь проходит опрос в мессенджере, ответы сохраняются и выгружаются в Excel.

---

## 2) Роли и доступ

### 2.1) Пользователь
- В системе существует один тип пользователя (условно **Admin**).
- Функции доступны полностью: управление ботами, каналами, сценариями, экспортами.

### 2.2) Аутентификация
MVP:
- Логин/пароль.
- Смена пароля.
- Сессия через cookie/JWT.

---

## 3) Каналы и интеграции

## 3.1) Telegram
- Подключение бота по токену BotFather.
- Использовать webhook.
- Поддержка:
  - входящие сообщения
  - отправка сообщений
  - кнопки (inline keyboard) для вариантов ответа

Webhook endpoint:
- `POST /webhooks/telegram/{bot_id}`

## 3.2) WhatsApp (самописно, без провайдера)
Требование: реализация через **официальный WhatsApp Business Platform Cloud API (Meta)**.
- Настройка Meta App, WhatsApp Business Account и phone number.
- Хранить и использовать:
  - `phone_number_id`
  - `waba_id` (если нужно)
  - access token (долгоживущий системный токен)
  - `verify_token` для подтверждения webhook

Поддержка:
- webhook verification (GET challenge)
- входящие сообщения
- отправка сообщений
- интерактивные ответы:
  - минимум: buttons (где возможно), иначе fallback на текстовый ввод

Webhook endpoints:
- `GET /webhooks/whatsapp/{bot_id}` (верификация)
- `POST /webhooks/whatsapp/{bot_id}` (события)

Fallback‑правило для WhatsApp:
- если интерактивные кнопки недоступны, отправлять список вариантов и принимать ответ цифрой или текстом.

---

## 4) Основные сущности и хранение данных

Рекомендуемая БД: PostgreSQL.

### 4.1) Bot
- `id`
- `name`, `description`
- `status`: `draft | active | archived`
- `active_script_version`
- `created_at`, `updated_at`

### 4.2) ChannelConfig
Для каждого бота хранить конфигурации каналов.

Telegram:
- `telegram_bot_token` (зашифрованно)

WhatsApp:
- `whatsapp_phone_number_id`
- `whatsapp_access_token` (зашифрованно)
- `whatsapp_verify_token` (зашифрованно)

### 4.3) Script (версионирование)
- `id`, `bot_id`
- `version` (целое, 1…N)
- `is_published` (true/false)
- `graph_json` (JSON сценария)
- `created_at`

Правило:
- опубликованная версия неизменяема.
- редактирование идёт в draft, публикация создаёт новую published‑версию.

### 4.4) Respondent
- `id`
- `channel`: `telegram | whatsapp`
- `external_id`: telegram user id или whatsapp phone
- `display_name` (если есть)
- `tags` (массив строк, опционально)
- `created_at`, `updated_at`

### 4.5) Session (прохождение сценария)
- `id`
- `bot_id`
- `respondent_id`
- `script_version`
- `state`: `active | finished | aborted`
- `current_block_id`
- `variables_json` (JSON)
- `started_at`, `finished_at`

### 4.6) Answer
- `id`
- `session_id`
- `respondent_id`
- `question_key` (стабильный ключ вопроса)
- `block_id`
- `answer_value` (string/JSON)
- `answered_at`

---

## 5) Конструктор сценариев

### 5.1) Общая модель
Сценарий — граф блоков:
- `blocks`: список блоков
- `edges`: переходы между блоками
- `entrypoint_block_id`: стартовый блок

### 5.2) Переменные
- Использовать формат подстановки `{{var_name}}` в текстах.
- Переменные хранятся на уровне Session (`variables_json`).
- Встроенные системные переменные (минимум):
  - `channel`
  - `external_id`
  - `display_name`

### 5.3) Набор блоков (MVP)

1) **Start**
- точка входа
- триггеры:
  - Telegram: `/start` (и опционально deep‑link параметр)
  - WhatsApp: ключевое слово (например, `start`) или первое сообщение

2) **Message**
- отправка текста
- поддержка подстановок переменных

3) **QuestionText**
- задаёт вопрос
- ждёт текстовый ответ
- сохраняет в переменную и как Answer
- опциональная валидация: min/max length

4) **QuestionSingleChoice**
- варианты ответа
- Telegram: кнопки
- WhatsApp: интерактивные кнопки, иначе список + ответ цифрой
- сохраняет выбранное значение

5) **QuestionScale**
- шкала 1..5 или 1..10
- Telegram: кнопки
- WhatsApp: интерактивные кнопки, иначе ответ числом

6) **SetVariable**
- установить `var_key = value`
- value может быть константой или ссылкой на другую переменную

7) **Condition (If/Else)**
- сравнение переменной или последнего ответа
- операторы: equals, not_equals, contains, in_list, gt, gte, lt, lte
- два выхода: true/false

8) **TagAdd / TagRemove** (опционально, но просто)
- добавить/удалить тег у Respondent

9) **GoTo**
- безусловный переход к указанному блоку

10) **End**
- завершение сессии
- финальное сообщение (опционально)

### 5.4) Редактор сценариев (UI)
MVP допускает два режима (выбор реализации за разработчиком):
- **Визуальный граф** (canvas) с соединениями
- или **Список блоков** с явным указанием переходов (быстрее для MVP)

Функции:
- добавить/удалить блок
- редактировать параметры блока
- настроить переходы (edges)
- публикация версии
- просмотр активной версии

### 5.5) Тестирование сценария
- Встроенный “симулятор чата” в админке:
  - пользователь вводит ответы
  - система показывает сообщения бота
  - тест не отправляет сообщения в реальные каналы

---

## 6) Движок исполнения (runtime)

### 6.1) Обработка входящего сообщения
Пайплайн:
1) определить `bot_id` по endpoint
2) нормализовать входящее событие в унифицированный формат
3) найти/создать Respondent
4) найти активную Session; если нет — создать по Start‑логике
5) выполнить шаг сценария:
   - если ожидается ввод, обработать ввод и сохранить Answer
   - перейти к следующему блоку
   - выполнять последовательные блоки, пока не упрёмся в блок, который ждёт ввод, или End
6) отправить пользователю необходимые сообщения/кнопки

### 6.2) Идемпотентность
- хранить `message_id` (для Telegram) и `wamid`/event id (для WhatsApp) в таблице обработанных событий
- повторные вебхуки не должны дублировать ответы

### 6.3) Ошибки ввода
- если ввод не проходит валидацию или не соответствует вариантам:
  - отправить подсказку
  - повторно показать вопрос

### 6.4) Параллельные сообщения
- если пользователь шлёт несколько сообщений подряд, система должна корректно обработать по очереди
- допускается “последовательная очередь” на Respondent (через транзакцию/лок)

---

## 7) Экспорт результатов в Excel (.xlsx)

### 7.1) Экспорт по боту
Экран “Exports”:
- кнопка: “Скачать Excel”
- фильтры:
  - период `date_from`, `date_to`
  - канал (telegram/whatsapp/все)
  - статус сессии (finished/все)

### 7.2) Формат Excel
Один файл, один лист `Results`.

Одна строка = одна Session.

Столбцы (фиксированный префикс):
- `session_id`
- `bot_id`
- `script_version`
- `channel`
- `external_id`
- `display_name`
- `started_at`
- `finished_at`
- `state`

Далее динамические столбцы по вопросам, в порядке появления в сценарии:
- `q_<question_key>`

Правила:
- если вопрос не задавался или пропущен — пустая ячейка
- multi‑значения (если появятся позже) писать строкой через запятую

Технология генерации:
- серверная генерация xlsx (например, openpyxl или аналог)
- файл отдаётся как download

---

## 8) Админка (экраны)

MVP‑набор:
1) Login
2) Bots list
3) Bot create/edit
   - имя/описание
   - включение каналов
   - настройки Telegram
   - настройки WhatsApp
4) Script editor
   - draft
   - publish
   - test (симулятор)
5) Exports
   - скачивание Excel

Опционально:
- список респондентов
- просмотр конкретной сессии и ответов

---

## 9) API (внутреннее, минимально)

### 9.1) Webhooks
- `POST /webhooks/telegram/{bot_id}`
- `GET /webhooks/whatsapp/{bot_id}` (verification)
- `POST /webhooks/whatsapp/{bot_id}`

### 9.2) Admin
- CRUD Bots
- CRUD Script draft
- Publish Script
- Test Script session (симулятор)
- Export xlsx

---

## 10) Нефункциональные требования

### 10.1) Безопасность
- секреты (tokens) хранить зашифрованно в БД
- логирование без вывода токенов

### 10.2) Производительность
- целевой объём MVP: до 10 000 ответов в месяц
- экспорт Excel должен формироваться за разумное время (ориентир: до 30 секунд на 50 000 ответов)

### 10.3) Надёжность
- ретраи отправки сообщений при временных ошибках API
- корректная обработка повторов webhook

---

## 11) Развёртывание

- Docker Compose:
  - backend
  - database (PostgreSQL)
  - (опционально) redis/queue worker для ретраев
- Конфиги через ENV.
- Документация: README по развёртыванию и настройке каналов (Telegram/WhatsApp).

---

## 12) Критерии приёмки

1) Можно создать бота, подключить Telegram токен, опубликовать сценарий, пройти опрос в Telegram, увидеть ответы в БД и скачать Excel.
2) Можно подключить WhatsApp Cloud API без провайдера, пройти тот же сценарий в WhatsApp и скачать Excel с результатами.
3) Работают блоки: Start, Message, QuestionText, QuestionSingleChoice, QuestionScale, SetVariable, Condition, End.
4) Подстановки `{{var}}` работают в Message.
5) Повторная доставка webhook одного и того же сообщения не создаёт дубликатов Answer.
6) Экспорт Excel формирует одну строку на сессию и содержит колонки `q_<question_key>`.

---

## 13) Артефакты, которые должен выдать разработчик

- Репозиторий с исходным кодом.
- Docker Compose.
- Миграции БД.
- README:
  - запуск локально
  - деплой
  - как создать Telegram bot и подключить webhook
  - как настроить WhatsApp Cloud API и подключить webhook
- Набор примерных сценариев (2–3 штуки):
  - onboarding‑опрос
  - опрос удовлетворённости
  - exit interview (краткий)

