# Исправление проблемы с застревающими уведомлениями

## Проблема
Пользователи сообщили о проблеме, когда уведомления от приложения застревают на шторке уведомлений и не могут быть убраны даже после закрытия приложения. Единственным решением была перезагрузка устройства.

Также был запрос на возможность удаленного получения логов для отладки, чтобы не нужно было физически забирать планшет каждый раз.

## Решение

### 1. Исправление застревающих уведомлений

#### Корневая причина:
- Уведомления были установлены как `.setOngoing(true)` безусловно, что делало их неудаляемыми
- Foreground сервис не останавливался, когда не было активных таймеров
- Не было механизма автоматической очистки при закрытии приложения без активных задач

#### Внесенные изменения:

**TimerService.kt:**

1. **Изменен метод `createNotification()`:**
   ```kotlin
   val hasActiveTimer: Boolean
   // ... логика определения hasActiveTimer ...
   .setOngoing(hasActiveTimer) // Вместо .setOngoing(true)
   ```
   - Добавлена переменная `hasActiveTimer` для отслеживания наличия активных таймеров
   - Уведомление теперь может быть удалено пользователем, когда нет активных таймеров

2. **Добавлен метод `checkAndStopServiceIfNoActiveTimers()`:**
   ```kotlin
   private fun checkAndStopServiceIfNoActiveTimers() {
       val hasActiveTimers = _allUserStates.value.values.any { it.activeTaskId != null }
       if (!hasActiveTimers) {
           Timber.i("No active timers remaining. Stopping foreground service.")
           stopForeground(STOP_FOREGROUND_REMOVE)
           stopSelf()
       }
   }
   ```
   - Проверяет наличие активных таймеров у всех пользователей
   - Автоматически останавливает foreground сервис и удаляет уведомление, когда не остается активных таймеров

3. **Изменен метод `stopTaskTimer()`:**
   - Добавлен вызов `checkAndStopServiceIfNoActiveTimers()` после остановки таймера
   - Обеспечивает автоматическую очистку при остановке последнего таймера

### 2. Добавлена возможность удаленной отладки

#### Реализация:

**BitrixApp.kt:**
- Включен `FileLoggingTree` для постоянного логирования в файл (не только в режиме отладки)
- Логи записываются во внешнее хранилище для легкого доступа

**LogExportHelper.kt (новый файл):**
- Создан утилитный класс для управления логами
- `shareLogFile()`: Поделиться логами через любое приложение (email, мессенджеры, облачное хранилище)
- `getLogFileSizeKB()`: Получить размер файла логов
- `clearLogFile()`: Очистить старые логи при необходимости

**TaskListScreen.kt:**
- Добавлен пункт меню "Экспорт логов для отладки"
- Доступен из меню настроек (иконка шестеренки)
- Одно нажатие для отправки логов через любое приложение

## Как использовать удаленную отладку:

1. Откройте приложение
2. Нажмите на иконку настроек (⚙️) в правом верхнем углу
3. Выберите "Экспорт логов для отладки"
4. Выберите, как поделиться (email, Telegram, WhatsApp и т.д.)
5. Отправьте разработчикам для удаленной отладки

## Технические детали:

### Хранение логов:
- Логи хранятся в специфичном для приложения внешнем хранилище (не требуются специальные разрешения)
- Расположение файла: `/Android/data/com.example.bitrix_app/files/logs/app_log.txt`
- Логи сохраняются между перезапусками приложения для исторической отладки
- Используется FileProvider для безопасного обмена файлами

### Поведение уведомлений:
- **С активным таймером**: Уведомление помечается как "ongoing" (постоянное) и не может быть удалено
- **Без активного таймера**: Уведомление может быть удалено свайпом
- **При закрытии приложения**: Если нет активных таймеров, сервис автоматически останавливается и удаляет уведомление

## Файлы, измененные в этом исправлении:

1. `app/src/main/java/com/example/bitrix_app/TimerService.kt` - Исправлено управление жизненным циклом уведомлений
2. `app/src/main/java/com/example/bitrix_app/MainActivity.kt` - Обновлены комментарии жизненного цикла сервиса
3. `app/src/main/java/com/example/bitrix_app/BitrixApp.kt` - Включено файловое логирование
4. `app/src/main/java/com/example/bitrix_app/LogExportHelper.kt` - Новая утилита для экспорта логов
5. `app/src/main/java/com/example/bitrix_app/ui/screen/TaskListScreen.kt` - Добавлен пункт меню экспорта логов
6. `gradle.properties` - Удален неверный путь к Java home

## Результат:

После этих изменений:
1. ✅ Уведомления больше не застревают на шторке
2. ✅ Уведомления могут быть удалены свайпом, когда нет активных таймеров
3. ✅ Сервис автоматически останавливается при отсутствии активных задач
4. ✅ Не требуется перезагрузка устройства для удаления застрявших уведомлений
5. ✅ Логи можно легко экспортировать для удаленной отладки
6. ✅ Не требуется физический доступ к планшету для получения логов

## Тестирование:

Для проверки исправления:

### Тест 1: Проверка удаления уведомления
1. Запустите таймер на задаче
2. Уведомление должно появиться и быть "постоянным" (не удаляется свайпом)
3. Остановите таймер
4. Уведомление должно исчезнуть автоматически
5. Если оно осталось, оно должно удаляться свайпом

### Тест 2: Проверка экспорта логов
1. Используйте приложение некоторое время
2. Откройте настройки (⚙️)
3. Выберите "Экспорт логов для отладки"
4. Должен появиться диалог выбора приложения для отправки
5. Выберите любое приложение и убедитесь, что файл логов прикреплен

### Тест 3: Проверка закрытия приложения
1. Запустите таймер
2. Уведомление должно быть видимым
3. Остановите таймер
4. Закройте приложение
5. Проверьте, что уведомление исчезло (не требуется перезагрузка)
